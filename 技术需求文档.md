# 个人AI OS系统 - 技术需求文档（Kimi K2工作流版）

## 1. 系统概述

### 1.1 项目目标
基于本地自动化脚本与Kimi K2 API构建个人AI操作系统，实现以下目标：
- 提高处理外部信息的效率
- 整理个人工作文件和知识体系
- 通过深度分析与广度思考增强决策能力

### 1.2 系统定位
个人知识操作系统，由本地Python工作流驱动，调用Kimi K2 API作为主要模型，为日常信息处理、主题分析和洞察拓展提供自动化服务。

### 1.3 核心用户场景
1. **信息收集与提炼**：自动抓取网页内容并生成结构化摘要文档。
2. **深度分析**：对问题调用多分析框架形成系统性分析报告。
3. **广度思考**：补充盲点与多维视角，生成新的洞察和预测。

## 2. 技术架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    AI OS 核心系统（本地）                  │
├─────────────────────────────────────────────────────────┤
│  控制层：Workflow Orchestrator（Python）                   │
│  模型层：Kimi K2 API                                         │
│  数据层：本地文件系统                                      │
├─────────────────────────────────────────────────────────┤
│  功能模块                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 信息处理模块  │  │ 深度分析模块  │  │ 广度思考模块  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│  外部集成：Chroma Web Clipper、第三方API（可选）            │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 信息处理模块
- **输入**：Chroma Web Clipper导出的Markdown或用户手动放入的文件
- **处理**：周目录创建、内容提炼、结果归档
- **输出**：`Summary`、`Key Takeaways`、`Something New`三段结构化Markdown

#### 2.2.2 深度分析模块（Super Analyst工作流）
- **输入**：用户问题与上下文
- **处理**：
  1. 框架筛选器（本地Python）评估问题→推荐框架组合
  2. 调用Kimi K2 API加载对应框架提示词并执行分析
  3. 将结果写入分析报告模板
- **输出**：存储于 `data/topic/` 的分析报告

#### 2.2.3 广度思考模块（New Angle工作流）
- **输入**：当前讨论摘要或分析结果
- **处理**：通过Kimi K2 API执行四步提示词流程：盲点分析、视角切换、跨领域类比、创新洞察
- **输出**：洞察报告（Markdown）

## 3. 目录结构规范

```
personal-ai-os/
├── data/
│   ├── raw/                # 原始内容（按周归档）
│   │   └── YYYY-MM-DD/
│   │       └── *.md
│   ├── medium-rare/        # 提炼结果
│   │   └── YYYY-MM-DD.md
│   └── topic/              # 深度分析报告
│       └── <topic-name>.md
├── workflows/
│   ├── super_analyst/
│   │   ├── pipeline.yaml   # 工作流配置
│   │   ├── prompts/        # 框架提示词模板
│   │   ├── framework_selector.py
│   │   └── run.py
│   └── new_angle/
│       ├── pipeline.yaml
│       ├── prompts/
│       └── run.py
├── scripts/
│   ├── folder_manager.py
│   ├── content_processor.py
│   └── cli.py              # 命令行入口
├── config/
│   ├── kimi_api.json       # Kimi K2 API配置（key、base_url、模型）
│   └── system_config.json
└── logs/
    └── *.log
```

### 3.2 命名规范
- **周目录**：`YYYY-MM-DD`（该周周一日期）
- **提炼文档**：与周目录同名，例如 `2025-01-06.md`
- **分析报告**：`<主题>-分析报告.md`
- **日志文件**：`YYYYMMDD_system.log`

## 4. 数据流设计

### 4.1 信息提炼流程

```
网页/文件 → data/raw/周目录
      ↓ folder_manager.py
读取所有Markdown → content_processor.py
      ↓ Kimi K2 API
生成提炼结构 → 保存到 data/medium-rare/周文档
```

### 4.2 Super Analyst工作流

```
用户问题 → framework_selector.py
      ↓
选出框架组合 → 加载模板 prompts/<framework>.md
      ↓
调用Kimi K2 API → run.py将结果填充到报告模板
      ↓
输出 Markdown → data/topic/<topic>.md
```

### 4.3 New Angle工作流

```
输入上下文 → new_angle/prompts/new_angle.md
      ↓
调用Kimi K2 API依次执行四步提问
      ↓
整合结果 → 输出Markdown洞察
```

## 5. 接口定义

### 5.1 Kimi K2 API接口

- **REST Endpoint**：`POST {base_url}/v1/chat/completions`
- **请求头**：`Authorization: Bearer <KIMI_API_KEY>`；`Content-Type: application/json`
- **基础请求体**：

```json
{
  "model": "kimi-k2",
  "messages": [
    {"role": "system", "content": "<系统提示>"},
    {"role": "user", "content": "<用户问题或模板填充后文本>"}
  ],
  "temperature": 0.7,
  "max_tokens": 4096
}
```

- **返回体**：解析`choices[0].message.content`获得生成文本。
- **重试机制**：当HTTP状态码≠200或超时时，间隔2秒重试，最多3次。

### 5.2 工作流配置接口（pipeline.yaml）

```yaml
name: super_analyst
steps:
  - id: select_frameworks
    script: framework_selector.py
  - id: build_prompt
    template: prompts/{framework_id}.md
  - id: call_kimi
    client: kimi_api
  - id: post_process
    handler: run.py::post_process
```

### 5.3 文件操作接口
- `create_week_folder()`：返回当前周目录路径（若不存在则创建）
- `collect_raw_markdown(week_path)`：返回文件列表与内容
- `write_summary(week, content)`：写入提炼文档
- `write_topic_report(topic, content)`：写入分析报告

## 6. 数据结构定义

```python
RawContent = {
    "path": str,
    "name": str,
    "body": str,
    "source": Literal["web_clipper", "manual"],
    "created_at": datetime
}

SummaryBlock = {
    "filename": str,
    "summary": str,
    "key_takeaways": List[str],
    "something_new": str
}

FrameworkMetadata = {
    "id": str,
    "name": str,
    "prompt_template": str,
    "keywords": List[str],
    "problem_types": List[str],
    "complexity": Literal["low", "medium", "high"],
    "expected_time": Literal["short", "medium", "long"],
    "description": str
}

AnalysisReport = {
    "topic": str,
    "date": date,
    "frameworks": List[str],
    "complexity": str,
    "duration": str,
    "summary": str,
    "sections": List[Dict[str, str]],
    "recommendations": List[str]
}
```

## 7. 技术栈与依赖

- **语言**：Python 3.10+
- **核心库**：
  - `httpx` 或 `requests`（调用Kimi K2 API）
  - `pydantic`（可选，用于数据模型校验）
  - `ruamel.yaml`（解析pipeline.yaml）
  - `rich`（命令行输出优化，可选）
- **CLI框架**：`typer` 或 `click`
- **模型服务**：Kimi K2 API（优先使用）
- **数据存储**：本地文件系统（Markdown）
- **外部工具**：Chroma Web Clipper（浏览器插件）

## 8. 配置管理

- `config/kimi_api.json`

```json
{
  "base_url": "https://api.moonshot.cn",
  "model": "moonshot-v1-32k",
  "api_key_env": "KIMI_API_KEY",
  "default_temperature": 0.7,
  "max_tokens": 4096,
  "endpoint_path": "/v1/chat/completions",
  "request_format": "openai"
}
```

- `config/system_config.json`

```json
{
  "timezone": "Asia/Shanghai",
  "week_start": "monday",
  "default_frameworks": ["first_principles", "swot"],
  "summary_sections": ["Summary", "Key Takeaways", "Something New"]
}
```

## 9. 环境要求
- 操作系统：macOS / Linux / Windows
- Python：3.10或更高
- 依赖管理：`pip` 或 `poetry`
- 环境变量：`KIMI_API_KEY`（必填）
- 网络：能够访问Kimi K2 API（支持代理配置）

## 10. 安全与隐私
- API密钥保存在环境变量或`.env`文件中，不写入仓库
- 日志中避免输出敏感信息（可通过脱敏函数）
- 所有数据保存在本地，用户自行负责同步与备份

## 11. 性能要求
- 单次摘要调用：平均延迟 < 5 秒（取决于Kimi K2响应）
- 深度分析执行：单框架分析 < 2 分钟，组合分析 < 5 分钟
- 框架选择器运行：< 1 秒
- 支持每周 ~200 篇文章的批量处理（约10MB文本）

## 12. 扩展设计
- 新增模型适配层：支持替换为其他OpenAI兼容API
- 框架扩展：只需新增`prompts/<framework>.md`和元数据即可
- 工作流扩展：通过新增`workflows/<name>/pipeline.yaml`实现
- UI扩展：后续可集成Web或桌面界面

## 13. 错误处理策略
- API调用失败：记录错误码与请求体摘要，自动重试，最终失败时将请求写入死信队列（`logs/failed_requests.log`）
- 文件写入失败：重试并在日志记录，必要时提示用户检查磁盘权限
- 模板缺失：回退到默认模板并发出warning
- 网络超时：支持代理或离线备份（手动处理）

## 14. 日志与监控
- 日志级别：DEBUG/INFO/WARNING/ERROR
- 日志字段：时间戳、模块、级别、消息、额外上下文
- 日志分文件存储，例如：`logs/super_analyst.log`
- 可选：集成Prometheus文本日志或简单统计脚本

## 15. 测试要求

### 15.1 单元测试
- `folder_manager.py`：目录创建逻辑
- `framework_selector.py`：关键词匹配与评分
- `content_processor.py`：文本拼装与格式化
- `cli.py`：命令参数解析

### 15.2 集成测试
- 模拟Kimi K2 API响应（使用`responses`或`pytest-httpx`）
- 工作流端到端测试（流水线配置 + 真实文件输入）
- 异常场景与超时逻辑

### 15.3 验收测试
- 信息提炼流程：输入样例文件 → 验证输出结构
- Super Analyst流程：从问题 → 报告 → 框架引用是否准确
- New Angle流程：四步输出是否覆盖预期内容
